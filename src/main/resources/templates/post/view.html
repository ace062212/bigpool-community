<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <title th:text="${post.title} + ' - BIGPOOL'">ê²Œì‹œê¸€ ì œëª© - BIGPOOL</title>
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}" />
    <style>
        .post-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .post-header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1.5rem;
        }
        
        .post-title {
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .post-meta {
            color: #6c757d;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .post-meta .author {
            font-weight: 500;
        }
        
        .post-content {
            line-height: 1.8;
            font-size: 1.05rem;
            margin-bottom: 3rem;
            white-space: pre-line;
        }
        
        .post-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 3rem;
        }
        
        .action-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            background-color: #f8f9fa;
            color: #0061f2;
            border: 1px solid #dee2e6;
        }
        
        .edit-btn:hover {
            background-color: #e9ecef;
            color: #004bbf;
        }
        
        .delete-btn {
            background-color: #f8d7da;
            color: #dc3545;
            border: 1px solid #f5c2c7;
        }
        
        .delete-btn:hover {
            background-color: #f1aeb5;
            color: #b02a37;
        }
        
        .comments-section {
            margin-top: 3rem;
            border-top: 1px solid #eee;
            padding-top: 2rem;
        }
        
        .comments-heading {
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #0061f2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .comment-count {
            background-color: #e6f2ff;
            color: #0061f2;
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }
        
        .comment-item {
            padding: 1.5rem;
            border-radius: 0.75rem;
            background-color: #f8f9fa;
            margin-bottom: 1rem;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .comment-author {
            font-weight: 600;
        }
        
        .comment-date {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .comment-content {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .comment-actions .btn {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
        }
        
        .comment-form {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
        }
        
        .comment-form textarea {
            border-radius: 0.5rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .comment-submit {
            background: linear-gradient(135deg, #0061f2 0%, #00c6f9 100%);
            border: none;
            border-radius: 50px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .comment-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,97,242,0.2);
        }
        
        .login-prompt {
            text-align: center;
            background-color: #f8f9fa;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
        }
        
        .login-link {
            color: #0061f2;
            font-weight: 500;
            text-decoration: none;
        }
        
        .login-link:hover {
            text-decoration: underline;
        }
        
        .back-to-list {
            display: none;
        }
        
        /* ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ìŠ¤íƒ€ì¼ */
        .image-gallery {
            margin: 2rem 0;
        }
        
        .gallery-item {
            margin-bottom: 2rem;
            overflow: hidden;
            max-width: 100%;
        }
        
        .gallery-item img {
            width: 100%;
            object-fit: contain;
            cursor: pointer;
            max-height: 800px;
            display: block;
            margin: 0 auto;
        }
        
        /* ìœ íŠœë¸Œ ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .youtube-container {
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="post-container">
            <!-- ê²Œì‹œê¸€ ì •ë³´ -->
            <div class="post-header">
                <h1 class="post-title" th:text="${post != null ? post.title : 'ê²Œì‹œê¸€ ì—†ìŒ'}">ê²Œì‹œê¸€ ì œëª©</h1>
                <div class="post-meta">
                    <span class="author">
                        <i class="fas fa-user me-1"></i>
                        <span th:if="${post != null && post.author != null}" th:text="${post.author.nickname}">ì‘ì„±ì</span>
                        <span th:if="${post == null || post.author == null}">ìµëª…</span>
                    </span>
                    <span class="date">
                        <i class="far fa-calendar me-1"></i>
                        <span th:if="${post != null}" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span>
                    </span>
                    <span class="views">
                        <i class="far fa-eye me-1"></i>
                        <span th:if="${post != null}" th:text="${post.viewCount} + ' ì¡°íšŒ'">0 ì¡°íšŒ</span>
                    </span>
                </div>
            </div>
            
            <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
            <div class="post-content" th:if="${post != null}" th:utext="${post.content}">ê²Œì‹œê¸€ ë‚´ìš©</div>
            
            <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ (Firebase Storage URL ì‚¬ìš©) -->
            <div class="image-gallery" th:if="${imageUrls != null && !imageUrls.isEmpty()}">
                <div class="row">
                    <div class="col-md-12 mb-3" th:each="imageUrl, status : ${imageUrls}" th:if="${imageUrl != null && !imageUrl.isEmpty()}">
                        <div class="gallery-item">
                            <img th:src="${imageUrl}" 
                                 class="img-fluid" 
                                 alt="ì²¨ë¶€ ì´ë¯¸ì§€"
                                 th:attr="data-image-index=${status.index + 1}"
                                 onclick="openImageViewer(this.src)">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° í‘œì‹œ -->
            <div class="alert alert-info" th:if="${imageUrls != null && imageUrls.isEmpty() && post.imageFiles != null && !post.imageFiles.isEmpty()}">
                <i class="fas fa-info-circle me-2"></i>ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            </div>
            
            <!-- ì¶”ì²œ/ë¹„ì¶”ì²œ ë²„íŠ¼ ì¶”ê°€ - ì´ë¯¸ì§€ ì•„ë˜ë¡œ ìœ„ì¹˜ ì´ë™ -->
            <div class="vote-buttons mb-4" sec:authorize="isAuthenticated()">
                <div class="d-flex gap-2">
                    <button type="button" th:class="${hasUpvoted ? 'btn btn-success active' : 'btn btn-outline-success'}" 
                            th:onclick="|votePost(${post.id}, true)|">
                        ğŸ‘ ì¶”ì²œ <span id="upvoteCount" th:text="${upvoteCount}">0</span>
                    </button>
                    <button type="button" th:class="${hasDownvoted ? 'btn btn-danger active' : 'btn btn-outline-danger'}" 
                            th:onclick="|votePost(${post.id}, false)|">
                        ğŸ‘ ë¹„ì¶”ì²œ <span id="downvoteCount" th:text="${downvoteCount}">0</span>
                    </button>
                </div>
            </div>
            
            <!-- ë””ë²„ê¹… ì •ë³´ (ê°œë°œ ì¤‘ì—ë§Œ ì‚¬ìš©) -->
            <div class="card mt-3 mb-3" th:if="${post.imageFiles != null && !post.imageFiles.isEmpty()}" style="display: none;">
                <div class="card-header">ë””ë²„ê¹… ì •ë³´</div>
                <div class="card-body">
                    <p><strong>ì´ë¯¸ì§€ URL ëª©ë¡:</strong> <span th:text="${imageUrls}"></span></p>
                    <p><strong>ì´ë¯¸ì§€ íŒŒì¼ ì›ë³¸:</strong> <span th:text="${post.imageFiles}"></span></p>
                    <p><strong>ì´ë¯¸ì§€ íŒŒì¼ ë¦¬ìŠ¤íŠ¸:</strong> <span th:text="${post.getImageFilesList()}"></span></p>
                </div>
            </div>
            
            <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
            <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="imageModalLabel">ì´ë¯¸ì§€ í™•ëŒ€ë³´ê¸°</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img id="modalImage" src="" class="img-fluid" alt="í™•ëŒ€ëœ ì´ë¯¸ì§€">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œ) -->
            <div th:if="${post != null && (isAuthor || isAdmin)}" class="post-actions">
                <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn action-btn edit-btn">
                    <i class="fas fa-edit me-1"></i> ìˆ˜ì •
                </a>
                <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" class="d-inline">
                    <button type="submit" class="btn action-btn delete-btn">
                        <i class="fas fa-trash-alt me-1"></i> ì‚­ì œ
                    </button>
                </form>
            </div>
            
            <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
            <div class="comments-section">
                <h3 class="comments-heading">
                    ëŒ“ê¸€ 
                    <span class="comment-count" th:text="${comments != null ? comments.size() : 0}">0</span>
                </h3>
                
                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div th:if="${comments == null || comments.empty}" class="alert alert-light">
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                </div>
                
                <div th:if="${comments != null && !comments.empty}" class="comments-list">
                    <div th:each="comment : ${comments}" class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author" th:text="${comment.author != null ? comment.author.nickname : 'ìµëª…'}">ëŒ“ê¸€ ì‘ì„±ì</span>
                            <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ëŒ“ê¸€ ë‚ ì§œ</span>
                        </div>
                        <div class="comment-content" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</div>
                        
                        <!-- ëŒ“ê¸€ ì‘ì„±ìë§Œ ë³¼ ìˆ˜ ìˆëŠ” ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                        <div th:if="${#authentication.principal != null && #authentication.principal.username == comment.author.username}" class="comment-actions">
                            <form th:action="@{'/comments/' + ${comment.id} + '/edit'}" method="get" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-primary">ìˆ˜ì •</button>
                            </form>
                            <form th:action="@{'/comments/' + ${comment.id} + '/delete'}" method="post" class="d-inline" 
                                  onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <div sec:authorize="isAuthenticated()" class="comment-form">
                    <form th:action="@{'/comments/post/' + ${post.id}}" method="post">
                        <div class="mb-3">
                            <label for="content" class="form-label">ëŒ“ê¸€ ì‘ì„±</label>
                            <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary comment-submit">ëŒ“ê¸€ ë“±ë¡</button>
                    </form>
                </div>
                
                <!-- ë¡œê·¸ì¸ ì•ˆëœ ê²½ìš° ë©”ì‹œì§€ -->
                <div sec:authorize="isAnonymous()" class="login-prompt">
                    <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    <a th:href="@{/login}" class="btn btn-primary login-link">ë¡œê·¸ì¸í•˜ê¸°</a>
                </div>
            </div>
        </div>
        
        <!-- ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë ˆì´ì•„ì›ƒ í”„ë˜ê·¸ë¨¼íŠ¸ ë‚´ë¶€ë¡œ ì´ë™ -->
        <script th:inline="javascript">
            //<![CDATA[
            const imageUrls = /*[[${imageUrls}]]*/ [];
            
            function openImageModal(imageSrc) {
                document.getElementById('modalImage').src = imageSrc;
                var myModal = new bootstrap.Modal(document.getElementById('imageModal'));
                myModal.show();
            }
            
            function openImageViewer(src) {
                window.open(src, '_blank', 'width=800,height=600');
            }
            
            function votePost(postId, isUpvote) {
                console.log('íˆ¬í‘œ ì‹œì‘:', isUpvote ? 'ì¶”ì²œ' : 'ë¹„ì¶”ì²œ', 'for post ID:', postId);
                
                const url = `/posts/api/${postId}/${isUpvote ? 'upvote' : 'downvote'}`;
                
                console.log('ìš”ì²­ URL:', url);
                console.log('í˜„ì¬ í˜ì´ì§€ ê²½ë¡œ:', window.location.pathname);
                console.log('ë¸Œë¼ìš°ì €ì—ì„œ ë³´ë‚´ëŠ” ì‹¤ì œ ìš”ì²­ ê²½ë¡œ:', window.location.origin + url);
                
                // AJAX ìš”ì²­ ì‹œ CSRF í† í° ì¶”ê°€
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                };
                
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                    console.log('CSRF í† í° ì¶”ê°€:', csrfHeader, csrfToken);
                } else {
                    console.warn('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                fetch(url, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include'
                })
                .then(response => {
                    console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                    console.log('ì‘ë‹µ í—¤ë”:', [...response.headers].map(h => `${h[0]}: ${h[1]}`).join('\n'));
                    
                    // ì‘ë‹µì´ okê°€ ì•„ë‹Œ ê²½ìš° (ìƒíƒœ ì½”ë“œê°€ 200-299 ë²”ìœ„ ë°–)
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('ì˜¤ë¥˜ ì‘ë‹µ ë‚´ìš©:', text);
                            throw new Error(text || 'íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                    return response.text();
                })
                .then(message => {
                    console.log('ì„±ê³µ ë©”ì‹œì§€:', message);
                    alert(message);
                    
                    const upvoteCount = document.getElementById('upvoteCount');
                    const downvoteCount = document.getElementById('downvoteCount');
                    
                    // íˆ¬í‘œ ìƒíƒœì— ë”°ë¥¸ ì¹´ìš´íŠ¸ ì¡°ì •
                    if (isUpvote) {
                        // ì¶”ì²œ ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°
                        if (message.includes('ì·¨ì†Œ')) {
                            // ì¶”ì²œ ì·¨ì†Œ
                            upvoteCount.textContent = parseInt(upvoteCount.textContent) - 1;
                        } else if (message.includes('ë¹„ì¶”ì²œì—ì„œ ì¶”ì²œìœ¼ë¡œ ë³€ê²½')) {
                            // ë¹„ì¶”ì²œì—ì„œ ì¶”ì²œìœ¼ë¡œ ë³€ê²½
                            upvoteCount.textContent = parseInt(upvoteCount.textContent) + 1;
                            downvoteCount.textContent = parseInt(downvoteCount.textContent) - 1;
                        } else {
                            // ìƒˆ ì¶”ì²œ
                            upvoteCount.textContent = parseInt(upvoteCount.textContent) + 1;
                        }
                    } else {
                        // ë¹„ì¶”ì²œ ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°
                        if (message.includes('ì·¨ì†Œ')) {
                            // ë¹„ì¶”ì²œ ì·¨ì†Œ
                            downvoteCount.textContent = parseInt(downvoteCount.textContent) - 1;
                        } else if (message.includes('ì¶”ì²œì—ì„œ ë¹„ì¶”ì²œìœ¼ë¡œ ë³€ê²½')) {
                            // ì¶”ì²œì—ì„œ ë¹„ì¶”ì²œìœ¼ë¡œ ë³€ê²½
                            downvoteCount.textContent = parseInt(downvoteCount.textContent) + 1;
                            upvoteCount.textContent = parseInt(upvoteCount.textContent) - 1;
                        } else {
                            // ìƒˆ ë¹„ì¶”ì²œ
                            downvoteCount.textContent = parseInt(downvoteCount.textContent) + 1;
                        }
                    }
                    
                    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€
                    const upvoteBtn = document.querySelector('button[onclick*="true"]');
                    const downvoteBtn = document.querySelector('button[onclick*="false"]');
                    
                    // ì¶”ì²œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                    if (isUpvote) {
                        if (message.includes('ì·¨ì†Œ')) {
                            upvoteBtn.classList.remove('btn-success');
                            upvoteBtn.classList.remove('active');
                            upvoteBtn.classList.add('btn-outline-success');
                        } else {
                            upvoteBtn.classList.remove('btn-outline-success');
                            upvoteBtn.classList.add('btn-success');
                            upvoteBtn.classList.add('active');
                            
                            // ë¹„ì¶”ì²œ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¶”ì²œìœ¼ë¡œ ì „í™˜í–ˆì„ ê²½ìš°)
                            if (downvoteBtn && message.includes('ë¹„ì¶”ì²œì—ì„œ ì¶”ì²œìœ¼ë¡œ ë³€ê²½')) {
                                downvoteBtn.classList.remove('btn-danger');
                                downvoteBtn.classList.remove('active');
                                downvoteBtn.classList.add('btn-outline-danger');
                            }
                        }
                    } else {
                        // ë¹„ì¶”ì²œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                        if (message.includes('ì·¨ì†Œ')) {
                            downvoteBtn.classList.remove('btn-danger');
                            downvoteBtn.classList.remove('active');
                            downvoteBtn.classList.add('btn-outline-danger');
                        } else {
                            downvoteBtn.classList.remove('btn-outline-danger');
                            downvoteBtn.classList.add('btn-danger');
                            downvoteBtn.classList.add('active');
                            
                            // ì¶”ì²œ ë²„íŠ¼ ë¹„í™œì„±í™” (ë¹„ì¶”ì²œìœ¼ë¡œ ì „í™˜í–ˆì„ ê²½ìš°)
                            if (upvoteBtn && message.includes('ì¶”ì²œì—ì„œ ë¹„ì¶”ì²œìœ¼ë¡œ ë³€ê²½')) {
                                upvoteBtn.classList.remove('btn-success');
                                upvoteBtn.classList.remove('active');
                                upvoteBtn.classList.add('btn-outline-success');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('ì—ëŸ¬ ë°œìƒ:', error);
                    alert('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            }
            
            // ì´ë¯¸ì§€ ë¡œë”© ì˜¤ë¥˜ ì²˜ë¦¬
            document.addEventListener('DOMContentLoaded', function() {
                // ëª¨ë“  ì´ë¯¸ì§€ ìš”ì†Œì— ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€
                const images = document.querySelectorAll('.gallery-item img');
                
                images.forEach(function(img, index) {
                    img.addEventListener('error', function() {
                        // ì˜¤ë¥˜ ì‹œ ëŒ€ì²´ ì´ë¯¸ì§€ í‘œì‹œ
                        this.src = '/images/error-image.png';
                        this.alt = 'ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨';
                        this.style.width = '200px';
                        this.style.height = 'auto';
                        
                        // ë¶€ëª¨ ìš”ì†Œì— ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ê°€
                        const galleryItem = this.closest('.gallery-item');
                        if (galleryItem) {
                            galleryItem.innerHTML += '<div class="alert alert-danger mt-2">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                        }
                    });
                });
            });
            //]]>
        </script>
    </div>
</body>
</html> 